# Simulation studies

The scripts in this directory can be used to recreate all figures in Sections 3 (Figures 4-8) and 4.2 (Figures 9-11) of the manuscript, as well as figures S.1-S.11 and Figure S.22A in the Supplemental Material. This README is organized by what simulations need to be run to produce a given set of figures, with the analysis commands and scripts to produce the figures noted therein.

**Prior to running the scripts in this directory, change the current working directory to this folder.** Also, if you have not already, install the additional plotting packages required by running the command
```
pip install "emsel[plots] @ git+https://github.com/steinrue/EMSel"
```


## Figures 4-6, 8, S.1-S.11

These figures are all generated from the large simulation described in Section 3. The simulated data can be recreated and reanalyzed by taking the following steps:

1. Create the directories `data`, `EM`, `classified`, `qsubs`, and `output` within this subdirectory (or externally, if you prefer).
2. Run `emsel-sim data -s .005 .01 .025 .05 -g 101 251 1001 -ic recip .005 .25 --sel_types neutral add dom rec over under --seed 5 -n 500`.
3. Run `python SLURM_example.py` with `EM_dir = Path('EM')` and `data_dir = Path('data')` at the beginning of the script, modifying the other parameters to your liking. This should generate 177 files to be run. Then, run `sh meta_sim_EM.sh` to submit the jobs to the cluster. Alternatively, for each dataset in `data`, running `emsel data/{file_name}_data.csv EM/{file_name}_EM --time_after_zero -maf 0 --min_sample_density 0 --full_output`.

Once the EM files are generated, the figures can be generated by running the following scripts in the specified configuration:

### Figures 4A, S.1-8A:
Set the following parameters at the beginning of the script `box_and_strip_plots.py` and run it using `python box_and_strip_plots.py`:
```
sel_strs = [.005, .01, .025, .05]
num_gens_list = [101, 251, 1001]
init_dists = [.005, .25, "recip"]
cond_only = False

data_dir = "data"
EM_dir = "EM"
classified_dir = "classified"
output_dir = "output"
```

### Figures 4B+C, S.1-8B+C:
Set the following parameters at the beginning of the script `qqs_and_aucs.py` and run it using `python qqs_and_aucs.py`:
```
sel_strs = [.005, .01, .025, .05]
num_gens_list = [101, 251, 1001]
init_dists = [.005, .25, "recip"]

EM_dir = "EM"
output_dir = "output"
```

### Figures 4D, 5, S.1-8D:
Set the following parameters at the beginning of the script `deltall_qqs_and_confusiontables.py` and run it using `python deltall_qqs_and_confusiontables.py`:
```
sel_strs = [.005, .01, .025, .05]
num_gens_list = [101, 251, 1001]
init_dists = [.005, .25, "recip"]

save_gengamma = False

EM_dir = "EM"
classified_dir = "classified"
output_dir = "output"
```

### Figure 6:
Set the parameter `cond_only = True` at the beginning of the script `box_and_strip_plots.py` and leave the rest of the configuration the same as Figures 4A et al. above. Run it using `python box_and_strip_plots.py`. Note that this will only run successfully after `deltall_qqs_and_confusiontables.py` has been run, since the `_classified.pkl` files must be generated.

### Figures 8A+B:

Set the following parameters at the beginning of the script `mismatched_boxplots.py` and run it using `python mismatched_boxplots.py`:
```
data_dir = "data"
EM_dir = "EM"
output_dir = "output"
```

### Figures 8C+D:
Run `python mismatched_auc_plots.py`. Modify the directory paths in the script if needed.

### Figures S.9-10:
First, run `python SLURM_extra_sims.py` (this should generate 105 files to be run) followed by `sh meta_sim_EM.sh`. This will generate the EM files needed for figures S.9-11. Alternatively, for every file in `data` that contains `g251_d25`, run `emsel data/{file_name}_g251_d25.csv EM/{file_name}_g251_d25_Ne5000_EM --time_after_zero -maf 0 --min_sample_density 0 --full_output -Ne 5000` and `emsel data/{file_name}_g251_d25.csv EM/{file_name}_g251_d25_Ne20000_EM --time_after_zero -maf 0 --min_sample_density 0 --full_output -Ne 20000` to reanalyze the 251 generations, init freq = 0.25 data under the 'incorrect' Nes.

Then, to generate Figure S.9, set the following parameters at the beginning of the script `file_str_boxplots.py` and run it using `python file_str_boxplots.py`:
```
sel_strs = [.005, .01, .025, .05]
num_gens = 251
init_dist = .25

data_dir = "data"
EM_dir = "EM"
output_dir = "output"

file_strs = ["Ne5000_", "", "Ne20000_"]
blank_name_str = "Ne10000_"
```

To generate Figure S.10, run `python Ne_misspec_qqs.py`. Modify the directory paths in the script if needed.

### Figure S.11:
If you have not already run `python SLURM_extra_sims.py` for Figures S.9-10 above, do so. Alternatively, for every file in `data` that contains `g251_d25`, run `emsel data/{file_name}_g251_d25_data.csv EM/{file_name}_g251_d25_ns100_linear_EM --time_after_zero -maf 0 --min_sample_density 0 --full_output -hs 100 --hidden_interp linear --ic_update_type fixed`, `emsel data/{file_name}_g251_d25_data.csv EM/{file_name}_g251_d25_linear_EM --time_after_zero -maf 0 --min_sample_density 0 --full_output --hidden_interp linear --ic_update_type fixed` and `emsel data/{file_name}_g251_d25_data.csv EM/{file_name}_g251_d25_fixed_ic_EM --time_after_zero -maf 0 --min_sample_density 0 --full_output -ic_update_type fixed` to reanalyze the 251 generations, init freq = 0.25 data under the (100 linearly interpolated hidden states, 500 linearly interpolated hidden states, 500 chebyshev interpolated hidden states, and 500 chebyshev interpolated hidden states but no initial condition estimation) conditions, respectively.

Then, set the parameters at the beginning of the script `file_str_boxplots.py` identical to those for Figure S.9 above, though with `file_strs = ["ns100_linear_", "linear_", "fixed_ic_", ""]` and `blank_name_str = "standard_"` instead, and run it using `python file_str_boxplots.py`.

## Figure 7:
This figure requires additional simulations. Proceed via the following:

1. Create the subdirectories `data/param_variation` and `EM/param_variation`
2. For ns in `[6, 20, 50, 100, 200]`, run `emsel-sim data/param_variation -s .025 -g 251 -ic .25 --sel_types add dom rec --seed 5 -n 500 -ns {ns}`.
3. For st in `[2, 5, 11, 35, 101]`, run `emsel-sim data/param_variation -s .025 -g 251 -ic .25 --sel_types add dom rec --seed 5 -n 500 -st {st}`.
4. For Ne in `[100, 1000, 10000, 100000, 1000000]`, run `emsel-sim data/param_variation -s .025 -g 251 -ic .25 --sel_types add dom rec --seed 5 -n 500 -Ne {Ne}`.
5. Run `python SLURM_example.py` with `EM_dir = Path('EM/param_variation')` and `data_dir = Path('data/param_variation')` at the beginning of the script. This should generate 60 files to be run. Then, submit the jobs using `sh meta_sim_EM.sh`. Alternatively, for all files now in `data/param_variation`, run `emsel data/param_variation/{file_name}_data.csv EM/{file_name}_EM --time_after_zero -maf 0 --min_sample_density 0 --full_output`
6. If you did not run the SLURM script, for all combinations of sel_type in `[add, dom, rec]` and hs in `[100, 250, 500, 1000, 2000]`, run `emsel data/{sel_type}_s025_g251_d25_data.csv EM/param_variation/{sel_type}_s025_g251_d25_hs{hs}_EM --time_after_zero -maf 0 --min_sample_density 0 -hs hs --selection_modes {sel_type} --full_output`.
7. Run `python param_variation_plots.py`.

## Figures 9-11:
First, run the pipeline in the [figures/gb_dataset/](../gb_dataset/) folder up to the point where the `GB_v54.1_capture_only_means.txt` and `GB_v54.1_capture_only_missingness.txt` files are created (i.e. run the "All figures" section), then copy these two files and the `GB_v54.1_capture_only_sample_sizes.table` file into `data`.

Next, run `emsel-sim data -s .005 .01 .025 .05 --sel_types neutral add dom rec over under --seed 5 -n 10000 --data_matched data/GB_v54.1_capture_only_means.txt data/GB_v54.1_capture_only_missingness.txt data/GB_sample_sizes.table`. This should generate 21 files, each with "g125_dal_special" somewhere in their name.

Next, run `python SLURM_example.py` with `EM_dir = Path('EM')` and `data_dir = Path('data')` at the beginning of the script. This should generate 105 files to be run. Then, run `sh meta_sim_EM.sh` to submit the jobs to the cluster. Alternatively, for each file created, run `emsel data/{file_name}_data.csv EM/{file_name}_EM --time_after_zero --full_output`.

If you ran the SLURM script, run `python combine_split_runs.py`. You should have 21 files.

Then:

### Figure 9A:

Set the following parameters at the beginning of the script `box_and_strip_plots.py` and run it using `python box_and_strip_plots.py`:
```
sel_strs = [.005, .01, .025, .05]
num_gens_list = [125]
init_dists = ["real_special"]
cond_only = False

data_dir = "data"
EM_dir = "EM"
classified_dir = "classified"
output_dir = "output"
```

### Figure 9B+C:
Set the following parameters at the beginning of the script `qqs_and_aucs.py` and run it using `python qqs_and_aucs.py`:
```
sel_strs = [.005, .01, .025, .05]
num_gens_list = [125]
init_dists = ["real_special"]

EM_dir = "EM"
output_dir = "output"
```

### Figure 9D+10:
Set the following parameters at the beginning of the script `deltall_qqs_and_confusiontables.py` and run it using `python deltall_qqs_and_confusiontables.py`:
```
sel_strs = [.005, .01, .025, .05]
num_gens_list = [125]
init_dists = ["real_special"]

save_gengamma = True

EM_dir = "EM"
classified_dir = "classified"
output_dir = "output"
```
Note the `save_gengamma = True`.

### Figure 11:
Run `python box_and_strip_plots.py` with the same configuration as Figure 9A, but with `cond_only = True`.

## Figure 22A:
1. Run `python permute_data_matched.py`
2. Run `python SLURM_example.py` with `EM_dir = Path('EM')` and `data_dir = Path('data')` at the beginning of the script. This should generate 100 files to be run. Then, run `sh meta_sim_EM.sh`. Alternatively, for i in range(100), run `emsel data/neutral_g125_dal_special_perm{i}_data.csv EM/neutral_g125_dal_special_perm{i}_EM --time_after_zero -maf 0 --min_sample_density 0 --full_output`.
3. If you ran the SLURM script, run `python combine_split_runs.py`. This will reformat the files (but not actually combine anything). You should have 100 files. 
4. Run `python plot_data_matched_permutations.py`. Both a .png and a .pdf are outputted, since the .pdf is quite large.
